<% content_for :breadcrumbs do %>
  <%= breadcrumbs do |list| %>
    <% list.link "Analytics", a_analytics_path %>
    <% list.link "Callers", callers_a_analytics_path %>
  <% end %>
<% end %>
<% content_for :page_head do %>
  <div class="-mt-6">
    <%= render partial: "index_page_head" %>
  </div>
<% end %>
<% if @callers.length > 0 %>
  <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
    <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
      <div class="shadow overflow-hidden border-b border-gray-200">
        <table class="table-fixed min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">
                Caller
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">
                Callee
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">
                Recent reports
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">
                Last report
              </th>
              <th scope="col">
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @callers.each do |caller| %>
              <% caller.live_matches.each_with_index do |match, index| %>
                <% has_report = match.reports.count > 0 %>
                <% if has_report %>
                  <% last_report = match.reports.sort_by(&:created_at).last %>
                  <% days_since_last_report = (Date.today.to_date - last_report.created_at.to_date).to_i %>
                  <% alert = 30 < days_since_last_report %>
                <% end %>
                <tr>
                  <% if index == 0 %>
                    <td rowspan="<%= caller.live_matches.count %>" class="px-6 py-4 text-sm text-gray-500">
                      <%= link_to caller.name, pl_person_path(caller.person) %>
                    </td>
                  <% end %>
                  <td class="px-6 py-4 text-sm text-gray-500">
                    <%= link_to match.callee.name, pl_person_path(match.callee.person) %>
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-500">
                    <div class="flex">
                      <% match.reports.sort_by(&:created_at).take(3).each do |report| %>
                        <div>
                          <%= render TooltipComponent.new do |t| %>
                            <% t.target_content do %>
                              <div>
                                Report submitted: <%= format_date_as_days_since(report.created_at) %>
                              </div>
                              <div>
                                Caller: <%= report.humanized_caller_feeling %>, Callee: <%= report.humanized_callee_feeling %>
                              </div>
                            <% end %>

                            <% t.target do %>
                              <div class="flex justify-center items-center mr-4 border-2 py-0.5 pl-0.5 pr-1 rounded-md">
                                <%= callee_feeling(feeling: last_report.callee_feeling) %>
                                <%= caller_feeling(feeling: last_report.caller_feeling) %>
                              </div>
                            <% end %>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-500">
                    <% if has_report %>
                      <div class="<%= alert ? 'text-red-600' : 'text-gray-500' %>"><%= format_date_as_days_since(last_report.created_at) %></div>
                    <% else %>
                      <div class="italic">No reports</div>
                    <% end %>
                  </td>

                  <td class="px-6 py-4 text-sm text-gray-300">
                    <%= link_to a_match_path(match) do %>
                      <%= icon("three-dots", class: "w-5 h-5") %>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% else %>
  <div class="flex justify-center text-gray-600">
    No Callers have been added yet :(
  </div>
<% end %>
